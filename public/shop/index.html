<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>立國實業｜線上下單</title>
  <link rel="icon" href="/assets/favicon.png" />
  <style>
    body{font-family:system-ui,-apple-system;max-width:1100px;margin:0 auto;padding:16px}
    header{display:flex;justify-content:space-between;align-items:center}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:16px;margin-top:16px}
    .card{border:1px solid #e5e7eb;border-radius:12px;overflow:hidden}
    .card img{width:100%;height:160px;object-fit:cover}
    .card .body{padding:12px}
    .price{font-weight:700}
    .cart{position:fixed;right:16px;bottom:16px;background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:12px;max-width:360px;width:92%}
    .cart h3{margin:0 0 8px}
    .row{display:flex;justify-content:space-between;align-items:center;margin:8px 0}
    .muted{color:#6b7280;font-size:14px}
    .btn{cursor:pointer;padding:8px 12px;border-radius:10px;border:1px solid #111;background:#111;color:#fff}
    .btn.outline{background:#fff;color:#111}
    form input, form select, form textarea{width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:10px}
    form .two{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    dialog{border:none;border-radius:12px;max-width:640px;width:90%;}
  </style>
</head>
<body>
  <header>
    <h1>立國實業｜線上下單</h1>
    <button id="goCheckout" class="btn outline">前往結帳</button>
  </header>
  <section class="muted">工業安全用品｜公司抬頭與聯絡：02-0000-0000｜service@liguo.com.tw</section>

  <section id="products" class="grid"></section>

  <aside class="cart" id="cartPanel">
    <h3>購物車</h3>
    <div id="cartItems"></div>
    <div class="row"><span class="muted">小計</span><strong id="subtotal">NT$ 0</strong></div>
    <div class="row"><span class="muted">運費</span><strong id="shipping">NT$ 0</strong></div>
    <div class="row"><span>合計</span><strong id="total">NT$ 0</strong></div>
    <div class="row">
      <button id="clearCart" class="btn outline">清空</button>
      <button id="checkout" class="btn">結帳</button>
    </div>
    <div class="muted">付款：轉帳 / 貨到（可日後開啟信用卡/LINE Pay）</div>
  </aside>

  <!-- 結帳對話框 -->
  <dialog id="checkoutDlg">
    <form id="orderForm" method="dialog">
      <h3>訂購資料</h3>
      <div class="two">
        <div><label>姓名<input name="name" required></label></div>
        <div><label>電話<input name="phone" required></label></div>
      </div>
      <div><label>Email（收訂單）<input name="email" type="email" required></label></div>
      <div><label>配送方式
        <select name="shipping" required>
          <option value="宅配">宅配（黑貓/新竹）</option>
          <option value="超商取貨（先匯款）">超商取貨（先匯款）</option>
        </select>
      </label></div>
      <div><label>地址（宅配/超商門市）<input name="address" required></label></div>
      <div><label>付款方式
        <select name="payment" required>
          <option value="銀行轉帳">銀行轉帳</option>
          <option value="貨到付款">貨到付款</option>
          <option value="信用卡（綠界/藍新）">信用卡（綠界/藍新）</option>
        </select>
      </label></div>
      <div><label>備註<textarea name="note" rows="3" placeholder="尺寸、發票抬頭/統編等"></textarea></label></div>
      <div class="row" style="margin-top:12px">
        <button class="btn outline" id="cancelDlg" type="button">取消</button>
        <button class="btn" type="submit">送出訂單</button>
      </div>
    </form>
  </dialog>

  <script>
    const cart = JSON.parse(localStorage.getItem('cart')||'[]');
    const saveCart = ()=>localStorage.setItem('cart', JSON.stringify(cart));
    const fmt = n => 'NT$ ' + n.toLocaleString();

    async function loadProducts(){
      const res = await fetch('/api/products');
      const items = await res.json();
      const grid = document.getElementById('products');
      grid.innerHTML = items.map(p=>`
        <div class="card">
          <img src="${p.image}" alt="${p.name}">
          <div class="body">
            <div class="row"><strong>${p.name}</strong><span class="price">${fmt(p.price)}</span></div>
            <div class="muted">SKU：${p.sku}</div>
            <div class="row">
              <button class="btn outline" onclick='add(${JSON.stringify(p)})'>加入購物車</button>
            </div>
          </div>
        </div>`).join('');
    }

    function add(p){
      const found = cart.find(i=>i.sku===p.sku);
      if(found){ found.qty++; } else { cart.push({sku:p.sku,name:p.name,price:p.price,qty:1}); }
      saveCart(); renderCart();
    }

    function changeQty(sku,delta){
      const i = cart.find(x=>x.sku===sku);
      if(!i) return;
      i.qty += delta;
      if(i.qty<=0) cart.splice(cart.indexOf(i),1);
      saveCart(); renderCart();
    }

    function renderCart(){
      const wrap = document.getElementById('cartItems');
      if(!cart.length){ wrap.innerHTML = '<div class="muted">尚無商品</div>'; }
      else {
        wrap.innerHTML = cart.map(i=>`
          <div class="row">
            <span>${i.name} × ${i.qty}</span>
            <span>${fmt(i.price*i.qty)}</span>
          </div>
          <div class="row">
            <button class="btn outline" onclick="changeQty('${i.sku}',-1)">－</button>
            <button class="btn outline" onclick="changeQty('${i.sku}',+1)">＋</button>
          </div>
        `).join('');
      }
      const subtotal = cart.reduce((s,i)=>s+i.price*i.qty,0);
      const shipping = subtotal>2000 || subtotal===0 ? 0 : 100;
      document.getElementById('subtotal').textContent = fmt(subtotal);
      document.getElementById('shipping').textContent = fmt(shipping);
      document.getElementById('total').textContent = fmt(subtotal+shipping);
    }

    document.getElementById('clearCart').onclick = ()=>{ cart.length=0; saveCart(); renderCart(); };
    document.getElementById('checkout').onclick = ()=>{
      if(!cart.length){ alert('購物車是空的'); return; }
      document.getElementById('checkoutDlg').showModal();
    };
    document.getElementById('cancelDlg').onclick = ()=>document.getElementById('checkoutDlg').close();
    document.getElementById('goCheckout').onclick = ()=>document.getElementById('checkout').click();

    document.getElementById('orderForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const data = Object.fromEntries(new FormData(e.target).entries());
      const res = await fetch('/api/orders', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ customer:data, items:cart })
      });
      const r = await res.json();
      if(r.next){ window.location.href = r.next; return; }
      alert('訂單成立：'+ r.orderNo + '（我們已收到）');
      cart.length=0; saveCart(); renderCart();
      document.getElementById('checkoutDlg').close();
    });

    loadProducts(); renderCart();
  </script>
</body>
</html>
